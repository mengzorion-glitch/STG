# V0.7.0 - 音效系統 詳細步驟

## 需求規格

### 音效檔案清單
```
public/effects/
├── se_shoot_01.mp3      (玩家射擊 1)
├── se_shoot_02.mp3      (玩家射擊 2)
├── se_skill_01.mp3      (技能發射 1)
├── se_skill_02.mp3      (技能發射 2)
├── se_skill_03.mp3      (技能發射 3)
├── se_monster_attack.mp3 (怪物攻擊)
├── se_monster_kill.mp3   (怪物死亡)
├── se_ui_click.mp3       (UI 點擊)
├── se_ui_confirm.mp3     (UI 確認/技能蓄滿)
├── se_ui_start.mp3       (遊戲開始)
├── se_ui_popup.mp3       (UI 彈出)
└── se_ui_close.mp3       (UI 關閉)

public/audio/
├── bgm_startscreen.mp3   (開始畫面 BGM)
├── bgm_stage_main.mp3    (遊戲主旋律)
├── bgm_stage_bass.mp3    (遊戲低音軌)
└── bgm_stage_drums.mp3   (遊戲鼓軌)
```

### 音效觸發時機
| 音效類型 | 觸發時機 | 隨機選擇 |
|----------|----------|----------|
| shoot | 玩家每次發射子彈 | se_shoot_01/02 |
| skill | 大技能每輪發射 | se_skill_01/02/03 |
| skillReady | 能量蓄滿瞬間 | se_ui_confirm |
| monsterAttack | 怪物發射彈幕 | se_monster_attack |
| monsterKill | 怪物被打爆 | se_monster_kill |
| uiStart | 點擊開始遊戲 | se_ui_start |

### 音量設定
| 音效類型 | 音量 |
|----------|------|
| shoot | 0.15 |
| skill | 0.3 |
| skillReady | 0.8 |
| monsterAttack | 0.175 |
| monsterKill | 0.5 |
| BGM | 0.5 |

### 防爆音設定
| 音效類型 | 最小間隔 (ms) |
|----------|---------------|
| shoot | 50 |
| skill | 30 |
| skillReady | 500 |
| monsterAttack | 100 |
| monsterKill | 30 |
| UI 類 | 100 |

### BGM 系統
- **開始畫面**：單軌播放 `bgm_startscreen` (音量 0.5)
- **遊戲關卡**：三軌重疊播放
  - main: 0.1
  - bass: 0.8
  - drums: 0.8
- **重新開始**：不重播 BGM (檢查是否已在播放)

---

## 步驟 1：建立 SoundManager 類別

建立 `src/systems/SoundManager.ts`：

```typescript
export class SoundManager {
  private scene: Phaser.Scene;
  private lastPlayTime: Map<SoundType, number> = new Map();
  private masterVolume: number = 1.0;
  private bgmVolume: number = 0.5;
  private muted: boolean = false;
  private bgmTracks: Phaser.Sound.BaseSound[] = [];

  // 預載音效與 BGM
  static preload(scene: Phaser.Scene): void {
    // SE
    scene.load.audio('se_shoot_01', 'effects/se_shoot_01.mp3');
    // ... 其他音效

    // BGM
    scene.load.audio('bgm_startscreen', 'audio/bgm_startscreen.mp3');
    scene.load.audio('bgm_stage_main', 'audio/bgm_stage_main.mp3');
    scene.load.audio('bgm_stage_bass', 'audio/bgm_stage_bass.mp3');
    scene.load.audio('bgm_stage_drums', 'audio/bgm_stage_drums.mp3');
  }

  // 播放開始畫面 BGM
  playStartBGM(): void {
    this.stopBGM();
    const track = this.scene.sound.add('bgm_startscreen', {
      volume: this.bgmVolume,
      loop: true,
    });
    track.play();
    this.bgmTracks.push(track);
  }

  // 播放遊戲關卡 BGM (三軌重疊，重啟時不重播)
  playStageBGM(forceRestart: boolean = false): void {
    // 檢查是否已有 stage BGM 在播放
    const existingTrack = this.scene.sound.get('bgm_stage_main');
    if (!forceRestart && existingTrack && existingTrack.isPlaying) return;

    this.stopBGM();
    const tracks = [
      { key: 'bgm_stage_main', volume: 0.1 },
      { key: 'bgm_stage_bass', volume: 0.8 },
      { key: 'bgm_stage_drums', volume: 0.8 },
    ];
    for (const t of tracks) {
      const track = this.scene.sound.add(t.key, {
        volume: t.volume,
        loop: true,
      });
      track.play();
      this.bgmTracks.push(track);
    }
  }

  // 停止所有 BGM
  stopBGM(): void {
    for (const track of this.bgmTracks) {
      track.stop();
      track.destroy();
    }
    this.bgmTracks = [];
  }
}
```

---

## 步驟 2：整合到 StartScene

```typescript
private soundManager!: SoundManager;

create(): void {
  // 初始化音效管理器並播放開始畫面 BGM
  this.soundManager = new SoundManager(this);
  this.soundManager.playStartBGM();

  // 點擊開始遊戲
  this.input.once('pointerdown', () => {
    this.soundManager.stopBGM();  // 停止 BGM
    this.sound.play('se_ui_start', { volume: 0.6 });
    this.scene.start('MainScene');
  });
}
```

---

## 步驟 3：整合到 MainScene

```typescript
private soundManager!: SoundManager;

create(): void {
  this.soundManager = new SoundManager(this);
  this.monsterSystem.setSoundManager(this.soundManager);
  this.soundManager.playStageBGM();  // 播放三軌重疊 BGM
}
```

---

## 步驟 4：整合到 MonsterSystem

```typescript
private soundManager: SoundManager | null = null;

setSoundManager(manager: SoundManager): void {
  this.soundManager = manager;
}

spawn(): Monster {
  const monster = new Monster(...);
  monster.setSoundManager(this.soundManager);
  return monster;
}
```

---

## 步驟 5：整合到 Monster

```typescript
private soundManager: SoundManager | null = null;

setSoundManager(manager: SoundManager): void {
  this.soundManager = manager;
}

// 攻擊時播放音效
updateSine(): void {
  if (this.attackTimer >= 3) {
    this.bulletSystem.fireCircle(...);
    this.soundManager?.play('monsterAttack');
  }
}
```

---

## 完成檢查清單

- [ ] SoundManager 類別建立
- [ ] 音效預載 (StartScene)
- [ ] 玩家射擊音效 (隨機 01/02)
- [ ] 技能發射音效 (隨機 01/02/03)
- [ ] 技能蓄滿提示音效
- [ ] 怪物攻擊音效
- [ ] 怪物死亡音效
- [ ] 遊戲開始音效
- [ ] 防爆音機制 (minInterval)
- [ ] 音量控制 (masterVolume + mute)
- [ ] BGM 開始畫面 (單軌)
- [ ] BGM 遊戲關卡 (三軌重疊，各軌獨立音量)
- [ ] 重新開始不重播 BGM
