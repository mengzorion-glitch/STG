# V0.9.0 - BOSS 系統 詳細步驟

## 需求規格

### BOSS 結構
- 階層式零件系統 (Phaser Container 父子關係)
- 零件：身體 (body)、頭 (head)、左手 (left_arm)、右手 (right_arm)、核心 (core)
- 每個零件獨立 HP 與碰撞判定
- BOSS 整體 1.5 倍縮放

### 零件層級 (depth)
| 零件 | depth | 說明 |
|------|-------|------|
| right_arm | -1 | 身體後面 |
| body | 0 | 主體 |
| head | 1 | 身體前面 |
| core | 2 | 最前面 (裝飾) |
| left_arm | 3 | 最前面 |

### 零件定位 (百分比錨點)
| 零件 | anchorOnParentX | anchorOnParentY | originX | originY |
|------|-----------------|-----------------|---------|---------|
| head | 50 | 16 | 0.5 | 0.5 |
| left_arm | 58 | 23 | 0.5 | 0.15 |
| right_arm | 44 | 23 | 0.5 | 0.15 |
| core | 50 | 74 | 0.5 | 0.5 |

### 零件血量與傷害優先順序
| 零件 | HP | blockedBy |
|------|-----|-----------|
| left_arm | 300 | - |
| right_arm | 300 | - |
| head | 600 | left_arm, right_arm |
| body | 800 | head |

### 零件動畫
| 零件 | 動畫類型 | 說明 |
|------|----------|------|
| head | breathe | Y 軸位移 (上下呼吸) |
| left_arm | breathe | Y 軸位移 |
| right_arm | breathe | Y 軸位移 |
| core | flicker | 透明度閃爍 |

### 攻擊模式
| 零件 | 類型 | 數量 | 角度 | 間隔 |
|------|------|------|------|------|
| body | circle | 12 | 360° | 4秒 |
| head | aimed | 3 | - | 2秒 (3連發) |
| left_arm | fan | 5 | 60° | 2.5秒 |
| right_arm | raise_fan | 5 | 60° | 3秒 |

### 小怪生成調整
- 生成間隔：2000ms → 3000ms
- 移除隨時間增加難度機制
- 固定每波 1 隻怪物

### 中型怪物攻擊調整
- 原本：停頓時發射 3 波扇形彈幕 (每波 8 發)
- 修改：停頓時朝玩家方向發射 3 顆直射子彈 (稍微散開)

---

## 步驟 1：建立 BOSS 資料定義

建立 `src/data/BossData.ts`：

```typescript
// 零件類型
export type BossPartType = 'core' | 'weapon' | 'armor' | 'limb';

// 零件動畫類型
export type BossPartAnim = 'none' | 'breathe' | 'flicker';

// 攻擊模式定義
export interface BossAttackPattern {
  type: 'circle' | 'fan' | 'aimed' | 'raise_fan';
  count: number;
  spreadDeg?: number;
  interval: number;
  burstCount?: number;
  burstDelay?: number;
  raiseDuration?: number;  // 抬起動畫時間
  raiseAngle?: number;     // 抬起角度 (度)
}

// 零件定義
export interface BossPartDef {
  id: string;
  type: BossPartType;
  spriteKey: string;
  anchorOnParentX: number;  // 在父零件上的 X 定位 (%)
  anchorOnParentY: number;  // 在父零件上的 Y 定位 (%)
  originX: number;          // 自身錨點 X (0-1)
  originY: number;          // 自身錨點 Y (0-1)
  depth: number;            // 渲染層級
  hp: number;
  hitboxRadius: number;
  anim?: BossPartAnim;
  blockedBy?: string[];     // 必須先擊破的零件
  attacks?: BossAttackPattern[];
  children?: BossPartDef[];
}
```

---

## 步驟 2：建立 BOSS 零件類別

建立 `src/entities/BossPart.ts`：

```typescript
export class BossPart extends Phaser.GameObjects.Container {
  private def: BossPartDef;
  private sprite: Phaser.GameObjects.Sprite;
  private currentHp: number;
  private partState: BossPartState = 'active';
  private childParts: BossPart[] = [];

  // 抬起動畫狀態
  private raiseState: 'idle' | 'raising' | 'firing' | 'lowering' = 'idle';

  constructor(scene: Phaser.Scene, def: BossPartDef, parentSprite?: Sprite) {
    // 計算相對於父零件的位置
    // 分離子零件：depth < 0 先加入 (在身體後面)
    // 建立身體 Sprite
    // 再加入 depth >= 0 的子零件
  }

  // 動畫更新
  private updateAnimation(deltaSeconds: number): void {
    switch (this.def.anim) {
      case 'breathe':
        // Y 軸位移
        this.sprite.y = Math.sin(this.animTimer * Math.PI) * 5;
        break;
      case 'flicker':
        // 透明度閃爍
        this.sprite.setAlpha(0.5 + Math.sin(this.animTimer * 10) * 0.5);
        break;
    }
  }

  // 抬起動畫
  private updateRaiseAnimation(deltaSeconds: number): void {
    // raising → firing → lowering → idle
  }

  // 檢查是否可被攻擊 (blockedBy 零件都已被擊破)
  private canBeHit(): boolean {
    if (!this.def.blockedBy) return true;
    for (const blockerId of this.def.blockedBy) {
      const blocker = this.rootPartRef.getPartById(blockerId);
      if (blocker && blocker.isActive()) return false;
    }
    return true;
  }
}
```

---

## 步驟 3：建立 BOSS 主類別

建立 `src/entities/Boss.ts`：

```typescript
export class Boss extends Phaser.GameObjects.Container {
  private def: BossDef;
  private rootPart: BossPart;
  private bossState: BossState = 'entering';

  // 飄動效果
  private floatTimer: number = 0;
  private baseY: number = 0;
  private readonly FLOAT_AMPLITUDE = 20;
  private readonly FLOAT_SPEED = 1.5;

  constructor(scene: Phaser.Scene, def: BossDef) {
    // 從畫面右側外開始
    const startX = scene.scale.width + 300;
    const startY = scene.scale.height / 2;
    super(scene, startX, startY);

    // 建立根零件
    this.rootPart = new BossPart(scene, def.rootPart);
    this.add(this.rootPart);

    // 放大 1.5 倍
    this.setScale(1.5);
  }

  // 進場動畫
  startEntrance(): void {
    this.scene.tweens.add({
      targets: this,
      x: this.scene.scale.width - this.def.entranceX,
      duration: this.def.entranceDuration * 1000,
      ease: 'Power2',
      onComplete: () => { this.bossState = 'active'; }
    });
  }

  // 飄動效果
  private updateFloat(deltaSeconds: number): void {
    this.floatTimer += deltaSeconds * this.FLOAT_SPEED;
    this.y = this.baseY + Math.sin(this.floatTimer) * this.FLOAT_AMPLITUDE;
  }
}
```

---

## 步驟 4：建立 BOSS 管理系統

建立 `src/systems/BossSystem.ts`：

```typescript
export class BossSystem {
  private scene: Phaser.Scene;
  private boss: Boss | null = null;

  static preload(scene: Phaser.Scene): void {
    // 載入 BOSS 圖片
    scene.load.image('boss_body', 'monster/boss_body.png');
    scene.load.image('boss_head', 'monster/boss_head.png');
    scene.load.image('boss_leftarm', 'monster/boss_leftarm.png');
    scene.load.image('boss_rightarm', 'monster/boss_rightarm.png');
    scene.load.image('boss_core', 'monster/boss_core.png');
  }

  spawnBoss(def: BossDef): Boss {
    this.boss = new Boss(this.scene, def);
    this.boss.setSystems(this.bulletSystem, this.player);
    this.boss.startEntrance();
    return this.boss;
  }

  getCollisionInfo(): CollisionInfo[] {
    return this.boss?.getCollisionInfo() || [];
  }

  damagePart(partId: string, amount: number): boolean {
    return this.boss?.damagePartById(partId, amount) || false;
  }
}
```

---

## 步驟 5：新增 BOSS 子彈

更新 `src/data/BulletData.ts`：

```typescript
export const BOSS_BULLET: BulletDef = {
  key: 'boss-bullet',
  speed: 400,
  damage: 2,
  size: 20,
  unitSize: 1.2,  // 較大的子彈
  frameCount: 1,
};
```

更新 `src/systems/BulletSystem.ts`：

```typescript
// 載入 BOSS 子彈
static preload(scene: Phaser.Scene): void {
  // ...
  for (let i = 0; i < BOSS_BULLET.frameCount; i++) {
    scene.load.image(`boss-bullet-${i}`, `monster/boss_bullet_${i}.png`);
  }
}

// 發射 BOSS 子彈
fireBoss(x: number, y: number, angle: number): Bullet {
  return this.fire(x, y, angle, BOSS_BULLET, 'monster');
}

// BOSS 扇形大型子彈
fireBossFan(x: number, y: number, spreadDeg: number, count: number): void {
  const baseAngle = Math.PI;
  const spreadRad = Phaser.Math.DegToRad(spreadDeg);
  const startAngle = baseAngle - spreadRad / 2;
  const step = count > 1 ? spreadRad / (count - 1) : 0;

  for (let i = 0; i < count; i++) {
    this.fireBoss(x, y, startAngle + step * i);
  }
}
```

---

## 步驟 6：調整小怪生成

更新 `src/systems/MonsterSystem.ts`：

```typescript
export class MonsterSystem {
  private spawnInterval: number = 3000;  // 3 秒
  private readonly spawnCount: number = 1;  // 固定 1 隻
  private playerRef: Player | null = null;  // V0.9.0: 玩家參考

  update(delta: number): void {
    // 移除難度增加邏輯
    this.spawnTimer += delta;
    if (this.spawnTimer >= this.spawnInterval) {
      this.spawnTimer = 0;
      this.spawnWave();
    }
    // ...
  }

  setPlayer(player: Player): void {
    this.playerRef = player;
  }
}
```

---

## 步驟 6.5：中型怪物瞄準攻擊

更新 `src/entities/Monster.ts`：

```typescript
export class Monster extends Phaser.GameObjects.Sprite {
  private playerRef: Player | null = null;

  /**
   * 衝刺-停頓移動 + 停頓時朝玩家發射3顆直射子彈
   */
  private updateDash(deltaSeconds: number): void {
    if (!this.isDashing) {
      // 停頓中 - 朝玩家發射3顆直射子彈
      if (!this.hasStartedAttack && this.bulletSystem && this.playerRef) {
        this.hasStartedAttack = true;

        // 計算朝向玩家的角度
        const angle = Phaser.Math.Angle.Between(
          this.x, this.y,
          this.playerRef.x, this.playerRef.y
        );

        // 發射3顆子彈 (稍微散開)
        const spreadStep = 0.15;  // 約 8.6 度
        for (let i = 0; i < 3; i++) {
          const offset = (i - 1) * spreadStep;
          this.bulletSystem.fireAimed(this.x, this.y, angle + offset);
        }

        this.soundManager?.play('monsterAttack');
      }
      // ...
    }
  }

  setPlayer(player: Player): void {
    this.playerRef = player;
  }
}
```

---

## 步驟 7：整合到 MainScene

更新 `src/scenes/MainScene.ts`：

```typescript
import { BossSystem } from '../systems/BossSystem';
import { BOSS_STAGE1 } from '../data/BossData';

export class MainScene extends Phaser.Scene {
  private bossSystem!: BossSystem;

  create(): void {
    this.bossSystem = new BossSystem(this);
    this.bossSystem.setSystems(this.bulletSystem, this.player);
    this.bossSystem.spawnBoss(BOSS_STAGE1);
  }

  private checkCollisions(): void {
    // 玩家子彈 vs BOSS 零件
    if (this.bossSystem.hasBoss()) {
      const bossCollisions = this.bossSystem.getCollisionInfo();
      for (const bullet of this.bulletSystem.getPlayerBullets()) {
        for (const partInfo of bossCollisions) {
          const dist = Phaser.Math.Distance.Between(
            bullet.x, bullet.y, partInfo.x, partInfo.y
          );
          if (dist < bullet.getRadius() + partInfo.radius) {
            this.bossSystem.damagePart(partInfo.partId, bullet.getDamage());
            this.bulletSystem.removeBullet(bullet);
            this.player.addEnergy(1);
            break;
          }
        }
      }
    }
  }
}
```

---

## 完成檢查清單

- [ ] BossData.ts - BOSS 與零件定義
- [ ] BossPart.ts - 零件類別 (Container)
- [ ] Boss.ts - BOSS 主類別
- [ ] BossSystem.ts - BOSS 管理系統
- [ ] 零件層級正確 (右手在身體後面)
- [ ] BOSS 1.5 倍縮放
- [ ] 上下飄動效果
- [ ] 右手保持抬起 75 度，定時發射 5 連發直線子彈
- [ ] 左手從 120 度往下揮，每 10 度發射 1 發 (共 12 發)
- [ ] 核心每 10 秒發射光束炮 (隨機 90 度內角度)
- [ ] 光束前搖 1 秒 (白色瞄準線)
- [ ] 閃爍動畫 (核心)
- [ ] 傷害優先順序 (blockedBy)
- [ ] 零件擊破換成 _b 圖片
- [ ] 頭部擊破噴出 8 隻小怪
- [ ] 身體擊破紅白閃爍下沉消失
- [ ] 勝利畫面 (VictoryScreen)
- [ ] BOSS 專用子彈 (放大 1 倍)
- [ ] 小怪生成間隔調整 (3 秒)
- [ ] 中型怪物朝玩家發射 3 顆直射子彈
