# V0.5.0 - 子彈系統 詳細步驟

## 需求規格

### 輸入操作
- 左鍵按下：立即發射 + 角色移動到點擊位置
- 左鍵持續按住：連續發射 (間隔 0.2 秒) + 角色跟隨滑鼠
- 左鍵放開：停止發射，回復 idle 動畫
- 右鍵：技能 (待實作)

### 玩家彈幕 (共 9 發)
| 類型 | 數量 | 發射角度 | 轉向後角度 | 轉向距離 |
|------|------|----------|------------|----------|
| 主砲 | 7 發 | ±30° (每發差10°) | ±3° (每發差1°) | 2 單位 |
| 副砲 | 2 發 | ±35° | ±15° (修正20°) | 4 單位 |

### 怪物血量 (以擊中次數計算)
| 類型 | 擊中次數 |
|------|----------|
| small | 15 |
| medium | 50 |

### 怪物攻擊
| 類型 | 攻擊模式 |
|------|----------|
| small | 每 3 秒噴出 8 發環形子彈 (360度) |
| medium | 停頓時發射 3 波扇形子彈 (160度、8發、間隔 0.2秒) |

### 碰撞系統
- 玩家子彈 vs 怪物：怪物閃紅、扣血、死亡回收
- 怪物子彈 vs 玩家：玩家閃紅 + hurt 動畫

### 層級順序
| 層級 | 物件 |
|------|------|
| 0-1 | 背景 |
| 5 | 怪物 |
| 7 | 玩家子彈 |
| 9 | 怪物子彈 |
| 10 | 玩家 |
| 100 | UI |

---

## 步驟 0：子彈資源

```
public/
├── player/
│   ├── player_bullet_0.png   (玩家子彈 幀0)
│   └── player_bullet_1.png   (玩家子彈 幀1)
└── monster/
    └── mob_bullet_0.png      (怪物子彈)
```

---

## 步驟 1：子彈資料定義

建立 `src/data/BulletData.ts`：

```typescript
/**
 * 子彈定義
 */
export interface BulletDef {
  key: string;        // 圖片key (動畫用基礎key)
  speed: number;      // 速度 (px/s)
  damage: number;     // 傷害
  size: number;       // 碰撞半徑
  unitSize: number;   // 單位大小 (0=不縮放)
  frameCount: number; // 動畫幀數
  turnAfterUnits?: number; // 飛行幾單位後轉向 (可選)
}

export const PLAYER_BULLET: BulletDef = {
  key: 'player-bullet',
  speed: 800,
  damage: 1,
  size: 10,
  unitSize: 0,  // 不縮放，使用原始大小
  frameCount: 2,
};

export const MOB_BULLET: BulletDef = {
  key: 'mob-bullet',
  speed: 300,
  damage: 1,
  size: 8,
  unitSize: 0.3,
  frameCount: 1,
};
```

---

## 步驟 2：子彈類別

建立 `src/entities/Bullet.ts`：

```typescript
import Phaser from 'phaser';
import { UNIT_SIZE } from '../config/GameConfig';
import { BulletDef } from '../data/BulletData';

export type BulletOwner = 'player' | 'monster';

export class Bullet extends Phaser.GameObjects.Sprite {
  private def: BulletDef;
  private owner: BulletOwner;
  private velocityX: number;
  private velocityY: number;

  // 轉向系統
  private startX: number;
  private startY: number;
  private turnDistance: number = 0;
  private hasTurned: boolean = false;

  constructor(
    scene: Phaser.Scene,
    x: number,
    y: number,
    angle: number,
    def: BulletDef,
    owner: BulletOwner,
    turnAfterUnits: number = 0
  ) {
    super(scene, x, y, `${def.key}-0`);
    scene.add.existing(this as Phaser.GameObjects.Sprite);

    this.def = def;
    this.owner = owner;
    this.startX = x;
    this.startY = y;
    this.turnDistance = turnAfterUnits * UNIT_SIZE;
    this.velocityX = Math.cos(angle) * def.speed;
    this.velocityY = Math.sin(angle) * def.speed;

    this.setDepth(owner === 'player' ? 7 : 9);
    this.setRotation(angle);
    this.setUnitSize(def.unitSize);
    this.initAnimation();
  }

  update(delta: number): void {
    const dt = delta / 1000;
    this.x += this.velocityX * dt;
    this.y += this.velocityY * dt;

    // 檢查是否需要轉向
    if (this.turnDistance > 0 && !this.hasTurned) {
      const traveled = Phaser.Math.Distance.Between(
        this.startX, this.startY, this.x, this.y
      );
      if (traveled >= this.turnDistance) {
        this.hasTurned = true;
        this.velocityX = this.def.speed;
        this.velocityY = 0;
        this.setRotation(0);
      }
    }
  }

  // ... 其他方法
}
```

---

## 步驟 3：子彈系統

建立 `src/systems/BulletSystem.ts`：

```typescript
import Phaser from 'phaser';
import { Bullet, BulletOwner } from '../entities/Bullet';
import { BulletDef, PLAYER_BULLET, MOB_BULLET } from '../data/BulletData';

export class BulletSystem {
  private scene: Phaser.Scene;
  private bullets: Bullet[] = [];

  static preload(scene: Phaser.Scene): void {
    // 玩家子彈 (多幀動畫)
    for (let i = 0; i < PLAYER_BULLET.frameCount; i++) {
      scene.load.image(`player-bullet-${i}`, `player/player_bullet_${i}.png`);
    }
    // 怪物子彈
    for (let i = 0; i < MOB_BULLET.frameCount; i++) {
      scene.load.image(`mob-bullet-${i}`, `monster/mob_bullet_${i}.png`);
    }
  }

  /**
   * 發射單發子彈
   */
  fire(x: number, y: number, angle: number, def: BulletDef, owner: BulletOwner, turnAfterUnits: number = 0): Bullet {
    const bullet = new Bullet(this.scene, x, y, angle, def, owner, turnAfterUnits);
    this.bullets.push(bullet);
    return bullet;
  }

  /**
   * 玩家彈幕：7發主砲 + 上下35度副砲
   * - 主砲：60度散開，2單位後漸進靠攏
   * - 副砲：±35度，4單位後修正到 ±15度
   */
  firePlayerSpread(x: number, y: number): void {
    // 主砲：7發，60度散開 (-30 ~ +30)，2單位後轉向靠攏
    // 發射角度: -30, -20, -10, 0, 10, 20, 30
    // 轉向角度:  -3,  -2,  -1, 0,  1,  2,  3
    const count = 7;
    const fireStep = 10;  // 發射時每發差 10 度
    const turnStep = 1;   // 轉向後每發差 1 度

    for (let i = 0; i < count; i++) {
      const offset = i - Math.floor(count / 2); // -3, -2, -1, 0, 1, 2, 3
      const fireDeg = offset * fireStep;        // -30, -20, -10, 0, 10, 20, 30
      const turnDeg = offset * turnStep;        //  -3,  -2,  -1, 0,  1,  2,  3

      const fireRad = Phaser.Math.DegToRad(fireDeg);
      const turnRad = Phaser.Math.DegToRad(turnDeg);

      this.fire(x, y, fireRad, PLAYER_BULLET, 'player', 2, turnRad);
    }

    // 副砲：±35 度，4單位後修正到 ±15 度
    this.fire(x, y, Phaser.Math.DegToRad(35), PLAYER_BULLET, 'player', 4, Phaser.Math.DegToRad(15));
    this.fire(x, y, Phaser.Math.DegToRad(-35), PLAYER_BULLET, 'player', 4, Phaser.Math.DegToRad(-15));
  }

  /**
   * 怪物環形彈幕
   */
  fireCircle(x: number, y: number, count: number): void {
    const step = (Math.PI * 2) / count;
    for (let i = 0; i < count; i++) {
      this.fire(x, y, step * i, MOB_BULLET, 'monster');
    }
  }

  /**
   * 怪物扇形彈幕 (向左發射)
   */
  fireFan(x: number, y: number, spreadDeg: number, count: number): void {
    const baseAngle = Math.PI;
    const spreadRad = Phaser.Math.DegToRad(spreadDeg);
    const startAngle = baseAngle - spreadRad / 2;
    const step = spreadRad / (count - 1);

    for (let i = 0; i < count; i++) {
      this.fire(x, y, startAngle + step * i, MOB_BULLET, 'monster');
    }
  }

  // ... 其他方法
}
```

---

## 步驟 4：更新怪物血量與攻擊

更新 `src/data/MonsterData.ts`：

```typescript
{ type: 'small', hp: 30, behavior: 'sine', ... }
{ type: 'medium', hp: 80, behavior: 'dash', ... }
```

更新 `src/entities/Monster.ts` 加入攻擊邏輯：

- small (sine): 每秒發射 8 發環形子彈
- medium (dash): 停頓時發射 3 波扇形子彈

---

## 步驟 5：更新玩家類別

更新 `src/entities/Player.ts` 加入受傷處理：

```typescript
takeDamage(_amount: number): void {
  // 閃紅效果
  this.setTint(0xff0000);
  this.scene.time.delayedCall(100, () => this.clearTint());

  // 播放受傷動畫
  this.setPlayerState('hurt');
}

getRadius(): number {
  return Math.min(this.displayWidth, this.displayHeight) / 2;
}
```

---

## 步驟 6：更新輸入系統

更新 `src/scenes/MainScene.ts`：

```typescript
// 屬性
private isLeftDown: boolean = false;
private fireTimer: number = 0;
private readonly FIRE_INTERVAL = 200; // 0.2秒

// update 中持續發射
if (this.isLeftDown) {
  this.fireTimer += delta;
  if (this.fireTimer >= this.FIRE_INTERVAL) {
    this.fireTimer = 0;
    this.bulletSystem.firePlayerSpread(this.player.x + 30, this.player.y);
    this.player.setPlayerState('attack');
  }
} else {
  if (this.player.getState() === 'attack') {
    this.player.setPlayerState('idle');
  }
}
```

---

## 步驟 7：碰撞檢測

```typescript
private checkCollisions(): void {
  const monsters = this.monsterSystem.getMonsters();
  const playerBullets = this.bulletSystem.getPlayerBullets();
  const monsterBullets = this.bulletSystem.getMonsterBullets();

  // 玩家子彈 vs 怪物
  for (const bullet of playerBullets) {
    for (const monster of monsters) {
      if (!monster.isAlive()) continue;
      const dist = Phaser.Math.Distance.Between(bullet.x, bullet.y, monster.x, monster.y);
      const hitRadius = bullet.getRadius() + monster.displayWidth / 2;
      if (dist < hitRadius) {
        const killed = monster.takeDamage(bullet.getDamage());
        this.bulletSystem.removeBullet(bullet);
        if (killed) {
          this.monsterSystem.removeMonster(monster);
        }
        break;
      }
    }
  }

  // 怪物子彈 vs 玩家
  for (const bullet of monsterBullets) {
    const dist = Phaser.Math.Distance.Between(bullet.x, bullet.y, this.player.x, this.player.y);
    const hitRadius = bullet.getRadius() + this.player.getRadius();
    if (dist < hitRadius) {
      this.player.takeDamage(bullet.getDamage());
      this.bulletSystem.removeBullet(bullet);
    }
  }
}
```

---

## 完成檢查清單

- [ ] 左鍵按下立即發射
- [ ] 左鍵持續按住連射 (0.2秒間隔)
- [ ] 發射時播放 attack 動畫
- [ ] 主砲 7發 60度散開，2單位後漸進靠攏 (±30° → ±3°)
- [ ] 副砲 2發 ±35度，4單位後修正到 ±15度
- [ ] 小怪物每秒 8發環形子彈
- [ ] 中怪物停頓時 3波扇形子彈
- [ ] 小怪物 15發死亡
- [ ] 中怪物 50發死亡
- [ ] 玩家被擊中閃紅 + hurt 動畫
- [ ] 怪物被擊中閃紅
- [ ] 怪物子彈層級高於玩家子彈
- [ ] 子彈離開畫面被回收
