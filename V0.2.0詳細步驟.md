# V0.2.0 - 視差背景系統 詳細步驟

## 步驟 1：背景系統類別

建立 `src/systems/ParallaxBackground.ts`：

```typescript
import Phaser from 'phaser';
import { GAME_HEIGHT } from '../config/GameConfig';

/**
 * 視差背景圖層
 */
interface ParallaxLayer {
    sprite: Phaser.GameObjects.TileSprite;
    speed: number;
}

/**
 * 視差背景系統
 * 管理多層背景的無縫捲動
 * 支援 EXPAND 模式下的動態寬度
 */
export class ParallaxBackground {
    private scene: Phaser.Scene;
    private layers: ParallaxLayer[] = [];
    private baseSpeed: number = 0.05;

    constructor(scene: Phaser.Scene) {
        this.scene = scene;

        // 監聽視窗大小變化，更新背景尺寸
        this.scene.scale.on('resize', this.onResize, this);
    }

    /**
     * 新增背景圖層
     * @param key 圖片資源 key
     * @param speed 相對捲動速度 (0~1, 數值越小越慢，表示越遠)
     * @param depth 圖層深度 (越小越底層)
     */
    addLayer(key: string, speed: number, depth: number): void {
        const w = this.scene.scale.width;
        const h = GAME_HEIGHT;

        // 使用動態寬度建立 TileSprite
        const sprite = this.scene.add.tileSprite(
            w / 2,
            h / 2,
            w,
            h,
            key
        );

        sprite.setDepth(depth);
        sprite.setScrollFactor(0);

        this.layers.push({ sprite, speed });
    }

    /**
     * 視窗大小變化時更新背景尺寸
     */
    private onResize(gameSize: Phaser.Structs.Size): void {
        const w = gameSize.width;
        const h = gameSize.height;

        for (const layer of this.layers) {
            layer.sprite.setPosition(w / 2, h / 2);
            layer.sprite.setSize(w, h);
        }
    }

    /**
     * 每幀更新捲動位置
     * @param delta 幀間隔時間 (ms)
     */
    update(delta: number): void {
        for (const layer of this.layers) {
            layer.sprite.tilePositionX += this.baseSpeed * layer.speed * delta;
        }
    }

    /**
     * 設定基礎捲動速度
     */
    setBaseSpeed(speed: number): void {
        this.baseSpeed = speed;
    }

    /**
     * 清除所有圖層
     */
    destroy(): void {
        this.scene.scale.off('resize', this.onResize, this);
        for (const layer of this.layers) {
            layer.sprite.destroy();
        }
        this.layers = [];
    }
}
```

**設計重點：**
- 使用 `TileSprite` 實現無縫捲動
- `tilePositionX` 增加 = 向左捲動（STG 標準方向）
- `setScrollFactor(0)` 確保背景不受攝影機影響
- **監聽 `resize` 事件**，動態調整背景尺寸適應 EXPAND 模式

---

## 步驟 2：整合到 MainScene

更新 `src/scenes/MainScene.ts`：

```typescript
import { ParallaxBackground } from '../systems/ParallaxBackground';

// 在類別屬性區塊加入
private parallaxBg!: ParallaxBackground;

// 在 preload() 中載入背景圖片
preload(): void {
  this.load.image('bg_far', 'images/bg_far.png');
  this.load.image('bg_mid', 'images/bg_mid.png');
}

// 在 create() 最開始初始化背景 (確保在最底層)
create(): void {
  // V0.2.0: 初始化視差背景 (最先建立，確保在最底層)
  this.parallaxBg = new ParallaxBackground(this);
  this.parallaxBg.addLayer('bg_far', 0.1, 0);  // 遠景，慢
  this.parallaxBg.addLayer('bg_mid', 0.6, 1);  // 中景，中速

  // ... 其他初始化
}

// 在 update() 中更新背景
update(_time: number, delta: number): void {
  this.parallaxBg.update(delta);
  // ... 其他更新
}
```

> **Note**: ParallaxBackground 內部已自動監聽 resize 事件，無需額外處理。

---

## 步驟 3：準備背景資源

在 `public/images/` 放置背景圖片：
- `bg_far.png` - 遠景 (星空、雲層)
- `bg_mid.png` - 中景 (山脈、建築剪影)

**圖片規格要求：**
- 尺寸：建議寬度 >= 2560 (支援 21:9 寬屏)
- 高度：1080
- 格式：PNG (支援透明度)
- 水平無縫：左右邊緣可無縫拼接

---

## 圖層配置參考

| 圖層 | Key | Speed | Depth | 說明 |
|------|-----|-------|-------|------|
| 遠景 | bg_far | 0.1 | 0 | 最慢，最底層 |
| 中景 | bg_mid | 0.6 | 1 | 中速，角色之下 |

> **Note**: Speed 值範圍 0~1，數值越小表示距離越遠（捲動越慢）。
> Depth 越小越底層，角色建議使用 depth 10 以上。

---

## EXPAND 模式行為說明

```
16:9 螢幕 (1920x1080):
+----------------------------------+
|         標準顯示區域              |
+----------------------------------+

21:9 螢幕 (~2520x1080):
+--------------------------------------------+
| 擴展區 |    標準顯示區域    | 擴展區        |
+--------------------------------------------+
         ↑ 1920 核心區 ↑

4:3 螢幕 (~1440x1080):
+------------------------+
|   較窄的顯示區域        |
+------------------------+
```

- **21:9 寬屏**：玩家可以看到更多左右兩側的敵人/背景
- **4:3 窄屏**：顯示較少內容，但核心遊戲區域仍可見
- **背景自動擴展**：TileSprite 會自動填滿整個可見區域

---

## 完成檢查清單

- [x] 遠景圖層正常顯示
- [x] 中景圖層正常顯示
- [x] 遠景捲動較慢 (speed: 0.1)
- [x] 中景捲動較快 (speed: 0.6)
- [x] 背景無縫循環捲動
- [x] 背景固定在攝影機上 (scrollFactor: 0)
- [x] 視窗大小變化時背景自動調整
- [x] 效能正常 (60 FPS)
